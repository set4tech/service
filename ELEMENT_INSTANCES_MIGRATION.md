# Element Instances Migration

## Overview

This migration normalizes the element check structure by introducing a dedicated `element_instances` table, replacing the denormalized `element_group_id` + `instance_label` pattern in the `checks` table.

## What Changed

### Before (Denormalized)

```
checks table:
- assessment_id
- element_group_id ────┐
- instance_label ──────┤ Together identify "Door 1"
- section_id          │
```

Multiple check rows with the same (`assessment_id`, `element_group_id`, `instance_label`) represented a single element instance.

### After (Normalized)

```
element_instances table:
- id (PK)
- assessment_id
- element_group_id
- label                ← "Door 1"

checks table:
- assessment_id
- element_instance_id ─→ element_instances.id
- section_id
```

One row in `element_instances` represents the element, multiple rows in `checks` link to it.

## New Files

1. **Migration**: `supabase/migrations/20251106_create_element_instances_table.sql`
   - Creates `element_instances` table
   - Adds trigger for auto-generating labels
   - Migrates existing data from checks table
   - Adds `element_instance_id` column to checks

2. **RPC Update**: `supabase/migrations/20251106_optimize_get_element_sections.sql`
   - Updated to return full section details (eliminates extra query)

3. **API Route**: `app/api/checks/create-element/route.ts`
   - Rewritten with modular helper functions
   - Reduced from 128 lines to ~175 lines (cleaner structure)
   - Now 3 round trips instead of 4-6

## API Flow

### Old Flow (4-6 round trips)

1. Get element group
2. RPC get_element_sections (returns IDs only)
3. Convert section_keys to section_ids (if old format)
4. Fetch full section details
5. Query existing labels (if auto-generating)
6. Insert checks with retry logic

### New Flow (3 round trips)

1. Get element group
2. Create element_instance (label auto-generated by trigger if needed)
3. RPC get_element_sections (returns full section details)
4. Insert checks

## Code Changes

### Route Structure

```typescript
// Modular, testable functions
async function getElementGroup(supabase, slug);
async function createElementInstance(supabase, assessmentId, elementGroupId, label);
async function getElementSections(supabase, elementGroupId, assessmentId);
async function createSectionChecks(
  supabase,
  assessmentId,
  elementInstanceId,
  instanceLabel,
  sections
);
```

## Benefits

✅ **Normalized schema** - No duplicate instance_label data across checks  
✅ **Auto-generated labels** - Trigger handles label generation  
✅ **Atomic operations** - Instance + checks created together  
✅ **Fewer round trips** - 3 instead of 4-6 database queries  
✅ **Cleaner queries** - Join on element_instance_id instead of (element_group_id, instance_label)  
✅ **Better data integrity** - FK constraints ensure consistency  
✅ **Easier management** - Delete instance = cascades to all checks  
✅ **Modular code** - Testable, reusable helper functions

## Migration Safety

The migration:

1. ✅ Creates new table and column
2. ✅ Migrates all existing data automatically
3. ✅ Verifies migration success (logs counts)
4. ✅ Keeps old columns for backwards compatibility
5. ⏸️ Old columns marked as DEPRECATED (will be removed in future)

## Backwards Compatibility

- Old columns (`element_group_id`, `instance_label`, `check_type`) remain in checks table
- They are marked as DEPRECATED in schema docs
- Will be removed in a future migration after all code is updated
- Existing queries will continue to work during transition period

## Testing the Migration

After running the migration:

```sql
-- Verify all data migrated
SELECT COUNT(*) FROM checks
WHERE element_group_id IS NOT NULL
  AND instance_label IS NOT NULL
  AND element_instance_id IS NULL;
-- Should return 0

-- Check instance count
SELECT COUNT(*) FROM element_instances;

-- Verify groupings match
SELECT
  COUNT(DISTINCT (assessment_id, element_group_id, instance_label)) as old_groupings,
  (SELECT COUNT(*) FROM element_instances) as new_instances;
-- Numbers should match
```

## Next Steps

After verifying the migration works in production:

1. Update other routes/queries that reference old columns
2. Update screenshot assignment functions
3. Update report generation queries
4. Remove old columns in future migration:
   ```sql
   ALTER TABLE checks DROP COLUMN element_group_id;
   ALTER TABLE checks DROP COLUMN instance_label;
   ALTER TABLE checks DROP COLUMN check_type;
   ```
